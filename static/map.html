<!DOCTYPE html>
<html>
<meta name="viewport" content="initial-scale=1.0, user-scalable=no">
<meta charset="utf-8">
<script type="text/javascript"
        src="https://maps.googleapis.com/maps/api/js?v=3.exp&signed_in=false&sensor=false&libraries=visualization,drawing"></script>
<script type="text/javascript" src="jquery-1.7.2.js"></script>
<script type="text/javascript" src="jquery.eventsource.js"></script>
<script type="text/javascript" src="heatmap.js"></script>
<script type="text/javascript" src="heatmap-gmaps.js"></script>


<script type="text/javascript">
    var map, pointarray, heatmap;
    var taxiData = [
        new google.maps.LatLng(37.782551, -122.445368)
    ];


    function initialize() {
        var config = {
            "radius": 30,
            "visible": true,
            "opacity": 60,
            "gradient": { 0.45: "rgb(0,0,255)", 0.55: "rgb(0,255,255)", 0.65: "rgb(0,255,0)", 0.95: "yellow", 1.0: "rgb(255,0,0)" }
        };

        var myOptions = {
            zoom: 5,
            center: new google.maps.LatLng(37.774546, -122.433523),
            mapTypeId: google.maps.MapTypeId.ROADMAP};

        map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
        heatmap = new HeatmapOverlay(map, config);
        google.maps.event.addListener(map, "idle", function () {
            //heatmap.setDataSet(testData);
        });

        /*
         google.maps.event.addListener(map, 'click', function (event) {
         placeMarker(event.latLng);
         });

         function placeMarker(location) {
         var marker = new google.maps.Marker({
         position: location,
         map: map
         });

         map.setCenter(location);
         }
         */

        var drawingManager = new google.maps.drawing.DrawingManager({
            drawingMode: google.maps.drawing.OverlayType.MARKER,
            drawingControl: true,
            drawingControlOptions: {
                position: google.maps.ControlPosition.TOP_CENTER,
                drawingModes: [
                    /*google.maps.drawing.OverlayType.MARKER,
                     google.maps.drawing.OverlayType.CIRCLE,
                     google.maps.drawing.OverlayType.POLYGON,
                     google.maps.drawing.OverlayType.POLYLINE,*/
                    google.maps.drawing.OverlayType.RECTANGLE
                ]
            },
            markerOptions: {
                icon: 'images/beachflag.png'
            },
            /*rectangleOptions: {
             editable: true,
             draggable: true
             },*/
            circleOptions: {
                fillColor: '#ffff00',
                fillOpacity: 1,
                strokeWeight: 5,
                clickable: false,
                editable: true,
                zIndex: 1
            }
        });
        drawingManager.setMap(map);

        var busy = 3;  // Three parallel reqs can be made
        google.maps.event.addListener(drawingManager, 'rectanglecomplete', function (rectangle) {
            if (busy === 0)
                Log("Busy in serving previous request(s). Try once they are complete", true);

            busy -= 1;
            var bounds = rectangle.getBounds();

            var logStr = "A : [long: " + bounds.va.j + ", lat: " + bounds.Da.j + "], B: [long: " + bounds.va.k + ", lat: " + bounds.Da.k + "]";
            Log("Generating heatmap for: " + logStr);
            console.log(logStr)

            var data = { ALong: bounds.va.j, ALat: bounds.Da.j, BLong: bounds.va.k, BLat: bounds.Da.k}

            $.ajax({
                url: "http://localhost:5000/rect",
                type: "POST",
                dataType: "json",
                data: data,
                success: function (data) {
                    for (var i = 0; i < data.tweets.length; i++) {
                        var tweet = JSON.parse(data.tweets[i]);
                        heatmap.addDataPoint(tweet.loc[1], tweet.loc[0]);
                    }
                    console.log("success", data);
                    Log('Heatmap complete. Found ' + data.tweets.length + " tweets in this area!", true)
                    rectangle.setMap(null);
                },
                error: function (err) {
                    console.log("error", err);
                    Log("Something went wrong in fetching data.", true)
                },
                complete: function () {
                    busy += 1;
                }
            })
        });

        function Log(message, newLine) {
            if (newLine)
                $("#result").append($("<p />").addClass("log mbottom25").html(message));
            else
                $("#result").append($("<p />").addClass("log").html(message));
        }

        /*
         google.maps.event.addListener(drawingManager, 'overlaycomplete', function (event) {
         if (event.type == google.maps.drawing.OverlayType.CIRCLE) {
         var radius = event.overlay.getRadius();
         }
         });
         */
    }
    ;


</script>

<style>
    body {
        font-family: sans-serif;
        font-size: 16px;
    }

    .log {
        margin: 2px;
    }

    .mbottom25 {
        margin-bottom: 25px;
    }
</style>

<body onload="initialize()">

<h1 style="text-align: center">Tweets HeatMap</h1>

<p>Start by marking an area...</p>

<div style="float: left; margin: 0 auto;">
    <div id="map_canvas" style="height: 600px; width: 800px; float: left"></div>
    <div id="result" style="float: left; width: 400px; height: 600px; overflow-y: scroll; margin-left: 25px"></div>
    <div style="clear: both"></div>
</div>
<!-- <button onclick="toggleHeatmap()">Toggle Heatmap</button>
<button onclick="changeGradient()">Change gradient</button>
<button onclick="changeRadius()">Change radius</button>
<button onclick="changeOpacity()">Change opacity</button> -->
</body>
</body>
</html>
