<!DOCTYPE html>
<html>
<meta name="viewport" content="initial-scale=1.0, user-scalable=no">
<meta charset="utf-8">
<title>Persistent Twitter Heatmap</title>
<script type="text/javascript"
        src="https://maps.googleapis.com/maps/api/js?v=3.exp&signed_in=false&sensor=false&libraries=visualization,drawing"></script>
<script type="text/javascript" src="jquery-1.11.2.min.js"></script>
<script type="text/javascript" src="jquery.eventsource.js"></script>
<script type="text/javascript" src="heatmap.js"></script>
<script type="text/javascript" src="heatmap-gmaps.js"></script>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>

<link rel="shortcut icon" href="twitter.ico">
<link href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css" rel="stylesheet">


<script type="text/javascript">

var map, pointarray, heatmap;

function initialize() {
    var config = {
        "radius": 30,
        "visible": true,
        "opacity": 60,
        "gradient": { 0.45: "rgb(0,0,255)", 0.55: "rgb(0,255,255)", 0.65: "rgb(0,255,0)", 0.95: "yellow", 1.0: "rgb(255,0,0)" }
    };

    var myOptions = {
        zoom: 5,
        center: new google.maps.LatLng(37.774546, -122.433523),
        mapTypeId: google.maps.MapTypeId.ROADMAP};

    map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
    heatmap = new HeatmapOverlay(map, config);
    google.maps.event.addListener(map, "idle", function () {
        //heatmap.setDataSet(testData);
    });

    /*
     google.maps.event.addListener(map, 'click', function (event) {
     placeMarker(event.latLng);
     });

     function placeMarker(location) {
     var marker = new google.maps.Marker({
     position: location,
     map: map
     });

     map.setCenter(location);
     }
     */

    var drawingManager = new google.maps.drawing.DrawingManager({
        drawingMode: google.maps.drawing.OverlayType.MARKER,
        drawingControl: true,
        drawingControlOptions: {
            position: google.maps.ControlPosition.TOP_CENTER,
            drawingModes: [
                /*google.maps.drawing.OverlayType.MARKER,
                 google.maps.drawing.OverlayType.CIRCLE,
                 google.maps.drawing.OverlayType.POLYGON,
                 google.maps.drawing.OverlayType.POLYLINE,*/
                google.maps.drawing.OverlayType.RECTANGLE
            ]
        },
        markerOptions: {
            icon: 'images/beachflag.png'
        },
        rectangleOptions: {
            editable: true,
            draggable: true
        },
        circleOptions: {
            fillColor: '#ffff00',
            fillOpacity: 1,
            strokeWeight: 5,
            clickable: false,
            editable: true,
            zIndex: 1
        }
    });
    drawingManager.setMap(map);

    var busy = false;

    var queryWindow = null, qwNe = null, qwSw = null, isBeignDragged = false;
    google.maps.event.addListener(drawingManager, 'rectanglecomplete', function (rectangle) {

        if (busy) {
            handleBusyState(rectangle);
            return;
        }

        if (queryWindow) {
            // remove exitsing rectangles if any
            // queryWindow.setMap(null);
        }
        queryWindow = rectangle;
        qwNe = queryWindow.getBounds().getNorthEast();
        qwSw = queryWindow.getBounds().getSouthWest();

        var bounds = getQueryWindowBounds(rectangle);
        generateHeatmap(bounds);

        google.maps.event.addListener(rectangle, 'dragstart', function () {
            isBeignDragged = true;
        });
        google.maps.event.addListener(rectangle, 'dragend', handleQueryWindowDrag);
        google.maps.event.addListener(rectangle, 'bounds_changed', handleQueryWindowResize);
        google.maps.event.addListener(rectangle, 'dblclick', handleDoubleClick);

    });

    function getQueryWindowBounds(rectangle) {
        var bounds = rectangle.getBounds();

        var logStr = "A : [long: " + bounds.va.j + ", lat: " + bounds.Da.j + "], B: [long: " + bounds.va.k + ", lat: " + bounds.Da.k + "]";
        Log("Generating heatmap for: " + logStr, true);
        console.log(logStr)

        var data = { ALong: bounds.va.j, ALat: bounds.Da.j, BLong: bounds.va.k, BLat: bounds.Da.k}
        return data;
    }

    function handleDoubleCilck(event) {
        console.log(
                "Double Clicked"
        );
    }

    function handleQueryWindowDrag(event) {
        isBeignDragged = false;
        handleQueryWindowChange(this);
    }

    function handleQueryWindowResize(event) {
        /*if (queryWindow == null)
         return; // query window doesnt exist

         if (busy) {
         handleBusyState(queryWindow);
         return;
         }

         var ne = queryWindow.getBounds().getNorthEast();
         var sw = queryWindow.getBounds().getSouthWest();

         if (!compareCoordinates(ne, qwNe) && !compareCoordinates(sw, qwSw)) {
         // Drag event
         qwNe = ne;
         qwSw = sw;
         return; // let the drag event handler take care
         }*/
        if (!isBeignDragged)
            handleQueryWindowChange(this);
    }

    function handleQueryWindowChange(rectangle) {

        if (queryWindow == null)
            return; // query window doesnt exist

        if (busy) {
            handleBusyState(rectangle);
            return;
        }

        var ne = rectangle.getBounds().getNorthEast();
        var sw = rectangle.getBounds().getSouthWest();


        var contentString = 'Query window changed: ' +
                'New north-east corner: ' + ne.lat() + ', ' + ne.lng() + '<br>' +
                'New south-west corner: ' + sw.lat() + ', ' + sw.lng();
        Log(contentString);

        var data = { ALong: sw.lng(), ALat: sw.lat(), BLong: ne.lng(), BLat: ne.lat()};
        generateHeatmap(data);
    }

    function generateHeatmap(data) {
        busy = true;
        $.ajax({
                    url: "http://localhost:5000/rect",
                    type: "POST",
                    dataType: "json",
                    data: data,
                    success: function (data) {
                        // var dataSet = [];
                        // heatmap.setDataSet({ max: -1, data: [] }); // clear existing data
                        for (var i = 0; i < data.tweets.length; i++) {
                            var tweet = JSON.parse(data.tweets[i]);
                            heatmap.addDataPoint(tweet.loc[1], tweet.loc[0]);
                            // dataSet.push([tweet.loc[1], tweet.loc[0]]);
                        }
                        // heatmap.setDataSet(dataSet);
                        console.log("success", data);
                        Log('Heatmap complete. Found ' + data.tweets.length + " tweets in this area!", false, true)

                        // remove the rectangle
                        // rectangle.setMap(null);
                    },
                    error: function (err) {
                        console.log("error", err);
                        Log("Something went wrong in fetching data.", true, true);
                    },
                    complete: function () {
                        busy = false;
                    }
                }
        )
    }

    function compareCoordinates(a, b) {
        // Assume their keys to be D and k
        return a.D === b.D && a.k === b.k;
    }

    function handleBusyState(rectangle) {
        Log("Busy serving another request. Please wait till its complete", true, true);
        rectangle.setMap(null);
    }

    function Log(message, spaceBelow, spaceAbove) {
        var cssClasses = ["log"];
        if (spaceBelow) cssClasses.push("mbottom25");
        if (spaceAbove) cssClasses.push("top25");

        $("#result").prepend($("<p />").addClass(cssClasses.join(" ")).html(message));
    }

    /*
     google.maps.event.addListener(drawingManager, 'overlaycomplete', function (event) {
     if (event.type == google.maps.drawing.OverlayType.CIRCLE) {
     var radius = event.overlay.getRadius();
     }
     });
     */


}

$(function () {

    showPanel();

    $(".btn").on("click", function () {
        var id = $(this).attr("id");
        if (id === "left") {
            hidePanel();
        }
        else if (id === 'right') {
            showPanel();
        }
    });

    function hidePanel() {
        $("#log_container").animate({left: -400}, 200, "swing");
        $("#right").show();
        $("#left").hide();
    }

    function showPanel() {
        $("#log_container").animate({left: 0}, 200, "swing");
        $("#right").hide();
        $("#left").show();
    }
});

</script>

<style>
    body {
        font-family: sans-serif;
        font-size: 16px;
    }

    .log {
        margin: 2px;
    }

    .mbottom25 {
        margin-bottom: 25px;
    }

    .top25 {
        margin-top: 25px;
    }
</style>

<body onload="initialize()">

<!-- <h1 style="text-align: center">Tweets HeatMap</h1> -->

<!-- <p>Start by marking an area...</p> -->

<div class="container">
    <div id="map_canvas" class="center" style="height: 600px; "></div>
    <div id="log_container" style="width: 452px; position: absolute; left: 0; top: 0;">
        <div style="width: 400px; height: 600px; overflow-y: scroll; background: #FFF;"
             class="pull-left">
            <h2 class="text-center">Updates</h2>
            <hr/>
            <div id="result"></div>
        </div>
        <button id="left" type="button" class="btn btn-default btn-lg pull-right">
            <span class="glyphicon glyphicon-menu-left" aria-hidden="true"></span>
        </button>
        <button id="right" type="button" class="btn btn-default btn-lg pull-right">
            <span class="glyphicon glyphicon-menu-right" aria-hidden="true"></span>
        </button>
    </div>
</div>

<!-- <button onclick="toggleHeatmap()">Toggle Heatmap</button>
<button onclick="changeGradient()">Change gradient</button>
<button onclick="changeRadius()">Change radius</button>
<button onclick="changeOpacity()">Change opacity</button> -->
</body>
</body>
</html>
